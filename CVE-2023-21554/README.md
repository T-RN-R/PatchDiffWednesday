# \<CVE-2023-21554\>: Remote Code Execution in MSMQ (QueueJumper)
*Mitchell T.*

## The Basics

**Disclosure or Patch Date:** April 11, 2023

**Product:** Microsoft Message Queueing Service

**Advisory:**
[CVE-2023-21554](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-21554),

**Affected Versions:** Likely all Windows since at least XP, until April 2023 patch level

**First Patched Version:** April 2023 patch

**Issue/Bug Report:** N/A

**Patch CL:** N/A

**Bug-Introducing CL:** N/A

**Reporter(s):** 
-  [Wayne Low of Fortinet's FortiGuard Lab](https://x9090.twitter.com/)
-   Haifei Li withÂ [Check Point Research](https://research.checkpoint.com/)

## The Vulnerability

**Bug class:** Out-of-bounds Read/Write

**Vulnerability details:**


**Patch analysis:**
Diffing `mqqm.dll`  10.0.22621.963 and 10.0.22621.1555, it can be seen that there are quite a few functions that changed, and a few added functions. The ones that bring attention to the eyes:
##### Added:
- `GetNextSectionPtrSafe`
- `CEodHeader::GetNextSectionSafe` 
- `CPropertyHeader::GetNextSectionSafe`  
- `CSecurityHeader::GetNextSectionSafe`
- `CSoapSection::GetNextSectionSafe`  
- `CUserHeader::GetNextSectionSafe`  
##### Modified:
- `CUserHeader::SectionIsValid`
- `CDebugSection::SectionIsValid`
- `CBaseMqfHeader::SectionIsValid`
- `CXactHeader::SectionIsValid`
- `CPropertyHeader::SectionIsValid`
- `CMsgDeadletterHeader::SectionIsValid`
- `CMsgGroupHeader::SectionIsValid`
- `CSecurityHeader::SectionIsValid`

It becomes evident that there was an issue with the `GetNextSection` functions, indicated by the new `GetNextSectionSafe` functions on the header classes.


```diff
--- mqqm.dll.10.0.22621.963
+++ mqqm.dll.10.0.22621.1555
@@ -1,35 +1,49 @@
 
 /* public: void __cdecl CDebugSection::SectionIsValid(char * __ptr64)const __ptr64 */
 
 void __thiscall CDebugSection::SectionIsValid(CDebugSection *this,char *param_1)
 
 {
-  char *pcVar1;
-  exception local_28 [40];
+  bool bVar1;
+  char *pcVar2;
+  __uint64 _Var3;
+  exception local_28 [32];
   
   if (1 < ((byte)*this & 3)) {
     if (((undefined **)WPP_GLOBAL_Control != &WPP_GLOBAL_Control) &&
        ((WPP_GLOBAL_Control[0x6c] & 1) != 0)) {
       WPP_SF_(*(undefined8 *)(WPP_GLOBAL_Control + 0x60),0x22,
-              &WPP_a42e52f147c9336096d5a05ce72d54ca_Traceguids);
+              &WPP_57b7b81b30ca3d8eee674fe8c1fa7960_Traceguids);
     }
     LogIllegalPoint((wchar_t *)L"verifypacket",0x5f5);
     exception::exception(local_28);
                     /* WARNING: Subroutine does not return */
     _CxxThrowException(local_28,(ThrowInfo *)&_TI1_AVexception__);
   }
-  pcVar1 = GetNextSection(this);
-  if (param_1 < pcVar1) {
-    if (((undefined **)WPP_GLOBAL_Control != &WPP_GLOBAL_Control) &&
-       ((WPP_GLOBAL_Control[0x6c] & 1) != 0)) {
-      WPP_SF_(*(undefined8 *)(WPP_GLOBAL_Control + 0x60),0x23,
-              &WPP_a42e52f147c9336096d5a05ce72d54ca_Traceguids);
+  bVar1 = wil::details::FeatureImpl<struct___WilFeatureTraits_Feature_MSRC76146_MSMQ_QMVariants>::
+          __private_IsEnabled(&`private:_static_class_wil::details::FeatureImpl<struct___WilFeatureTraits_Feature_MSRC76146_MSMQ_QMVariants>&___ptr64___cdecl_wil::Feature<struct___WilFeatureTraits_Feature_MSRC76146_MSMQ_QMVariants>::GetImpl(void)'
+                               ::`2'::impl);
+  _Var3 = 0;
+  if (bVar1) {
+    if (((*(ushort *)this & 3) != 0) && ((*(ushort *)this & 3) == 1)) {
+      _Var3 = 0x10;
     }
-    LogIllegalPoint((wchar_t *)L"verifypacket",0x5f6);
-    exception::exception(local_28);
+    pcVar2 = GetNextSectionPtrSafe((__uint64)this,4,_Var3,(char *)0x0);
+  }
+  else {
+    pcVar2 = GetNextSection(this);
+  }
+  if (pcVar2 <= param_1) {
+    return;
+  }
+  if (((undefined **)WPP_GLOBAL_Control != &WPP_GLOBAL_Control) &&
+     ((WPP_GLOBAL_Control[0x6c] & 1) != 0)) {
+    WPP_SF_(*(undefined8 *)(WPP_GLOBAL_Control + 0x60),0x23,
+            &WPP_57b7b81b30ca3d8eee674fe8c1fa7960_Traceguids);
+  }
+  LogIllegalPoint((wchar_t *)L"verifypacket",0x5f6);
+  exception::exception(local_28);
                     /* WARNING: Subroutine does not return */
-    _CxxThrowException(local_28,(ThrowInfo *)&_TI1_AVexception__);
-  }
-  return;
+  _CxxThrowException(local_28,(ThrowInfo *)&_TI1_AVexception__);
 }
```

#TODO deep  dive example of one of the header `SectionIsValid` diffs.

#TODO explain how this is reachable.

**Thoughts on how this vuln might have been found _(fuzzing, code auditing, variant analysis, etc.)_:** Likely manual audit. The researchers may have written their own client for the software and hit the bug immediately.


## The Next Steps

### Variant analysis

**Areas/approach for variant analysis (and why):**

**Found variants:**

