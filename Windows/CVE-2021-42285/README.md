# CVE-2021-42285
created: 2021-11-21
author: Mitchell T.

[CVE-2021-42285](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42285) is described as a Windows Kernel Elevation of Privilege vulnerability.


## Overview

Diffing `ntoskrnl.exe` between the KB5008212 and KB5007523 patches shows 1 change, the `PfpPrivSourceEnum` function. 
![PfpPrivSourceEnum diff](PatchDiffWednesday/Windows/CVE-2021-42285/img/PfpPrivSourceEnum-Diff.png) 

By walking up the tree of references to this function, it can be seen that the vulnerable system call is `NtQuerySystemInformation`.

![](PatchDiffWednesday/Windows/CVE-2021-42285/img/QueryCallTree.png)

So this is a vulnerability that allows elevation of privilege by invoking `NtQuerySystemInformation`. So what exactly changed with the patch?

It turns out, the only thing added was a `SeSinglePrivilegeCheck` on additional function calls in `PfpPrivSourceEnum`. 

```C
      local_207 = SeSinglePrivilegeCheck
                        (SeProfileSingleProcessPrivilege,uVar5 & 0xffffffffffffff00 | param_2 &0xff
                        );
```

This check is in both in the patched and unpatched versions. The result of the check is stored in `local_207`. Using git diff, we can see exactly what code was added between versions:

```diff
-                local_1e4 = MmGetSessionIdEx(lVar4);
-                local_1d0 = MmGetSessionGlobalVA(lVar4);
-                MiFillSessionWorkingSetEntry(&local_150,*(undefined8 *)(lVar4 + 0x558));
+                local_1e4 = MmGetSessionIdEx(lVar5);
+                if (local_207 != '\0') {
+                  local_1d0 = MmGetSessionGlobalVA(lVar5);
+                }
+                MiFillSessionWorkingSetEntry(&local_150,*(undefined8 *)(lVar5 + 0x558));
```

So the bug is an insufficient privilege check for the `SeProfileSingleProcessPrivilege` on invocations of `MmGetSessionGlobalVa`. 

## Details

Lets take a step back and try to understand the components at play. There are few questions that arise,

-   What is `NtQuerySystemInformation`
-   What is the `SeProfileSingleProcessPrivilege`
-   What is superfetch?
-   What is the purpose of `PfpPrivSourceEnum`?

### NtQuerySystemInformation
`NtQuerySystemInformation` is a system call that retreives a wide variety of system properties. The function looks like this:
```C
NTSTATUS 
NtQuerySystemInformation (
    SYSTEM_INFORMATION_CLASS SystemInformationClass, 
    PVOID SystemInformation, 
    ULONG SystemInformationLength, 
    ULONG *ReturnLength);
```
The first parameter, `SystemInformationClass` is an enum which dictates what kind of information is being queried. In the case of our code path, we are querying 0x4f, or `SystemSuperfetchInformation`.

```C
void ExpQuerySystemInformation
               (uint param_1,ulonglong *param_2,uint param_3,ulonglong *param_4,uint param_5,
               uint *param_6)
...
  case 0x4f:
    local_318 = (ulonglong **)&local_308;
    PfQuerySuperfetchInformation(piVar19,param_4,len,(ulonglong)bVar7);
    uVar10 = local_308;
    break;
...
```

`PfQuerySuperfetchInformation` also has a switch statement, and case 0x8 is our call to `PfpPrivSourceEnum`.

```C
    case 8:
      PfpPrivSourceEnum(&local_f0,(ulonglong)param_4,local_98);
      break;
```

Before reverse engineering `PfpPrivSourceEnum`, lets talk about privileges, superfetch and sessions.

###  Privileges
Privileges are a security mechanism applied to process tokens. They can be viewed by opening Process Explorer and viewing the Properties of a single process. Here are the security properties of the `csrss.exe` process, which is running as `NT AUTHORITY\SYSTEM`. 

![](PatchDiffWednesday/Windows/CVE-2021-42285/img/procexp.png)

There is a section that shows the available privileges for that process. As can be seen, the `SeProfileSingleProcessPrivilege` is default enabled for this process. 

Privileges are used to restrict the kinds actions that a process could perform. For example, the is an `SeDebugPrivilege` which allows a process to debug other processes. The security reference monitor checks the privilege of the current user via the `SeSinglePrivilegeCheck` function. 

#### What does `SeProfileSingleProcessPrivilege` do?

According to [Microsoft documentation](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/profile-single-process), it is used to sample the performance of a process.  To determine what this means, we can lookup XREFs to the `SeProfileSingleProcessPrivilege` within Ghidra.

![](PatchDiffWednesday/Windows/CVE-2021-42285/img/profilexref.png)

As the XREF list shows, it is used in functions like `MmIssueMemoryListCommand`, `SmProcessStatsRequest` and `MiIsUserQueryVmCallerTrusted`. What kind of functions does this privilege protect from under-privileged users?

In `SmQueryStoreInformation`, it seems to protect the functions `SmProcessCompressionInfoRequest`, `SmcProcessListRequest`, `SmProcessRegistrationRequest`, and `SmProcessStatsRequest`. 

In `MmIssueMemoryListCommand`, it protects a single function, `MmPerformMemoryListCommand`.

So now we have a general idea of what the `SeProfileSingleProcessPrivilege` protects.

### Superfetch
So we know that our `SYSTEM_INFORMATION_CLASS` is `SystemSuperfetchInformation`, what exactly does superfetch mean?

The `PfQuerySuperfetchInformation` function is called through `NtQuerySystemInformation` using the `SystemSuperfetchInformation` information class. It has what we will refer to as "superfetch information classes". There are several of this superfetch information classes. The following is an incomplete list of functions called using these sub-information classes:

- `PfGetCompletedTrace`
- `PfpPrivSourceEnum`
- `PfpQueryScenarioInformation`
- `PfpMemoryListQuery`
- `PfpMemoryRangesQuery`
- `PfpVirtualQuery`
- `MmLogQueryCombineStats`
- `PfpQueryFileExtentsRequest`
- `PfpQueryGpuUtilization`

A quick internet search indicates that superfetch pre-loads frequently used Windows applications into memory as a software startup performance improvement.

#TODO    Determine  why calling `PfpPrivSourceEnum` with insufficient privilege is bad, and then explain it



## Known Variants
This [Github PoC for CVE-2022-24483](https://github.com/waleedassar/CVE-2022-24483/blob/main/SystemSuperfetchInformation_Leak_POC/SystemSuperfetchInformation_Leak_POC.cpp) attacks the same information class