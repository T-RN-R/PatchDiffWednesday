# CVE-2022-24528


# Overview
These are all classic integer overflow bugs leading to buffer overflows within the RPC runtime. There isn't much to say about them, other than, good luck getting a functioning exploit out of these.

3 CVEs in rpcrt4.dll, 4 bugs :)
Just do a ctrl+F for UIntAdd/ULongAdd 



```cpp
typedef struct _RPC_MESSAGE {
  RPC_BINDING_HANDLE     Handle;
  unsigned long          DataRepresentation;
  void                   *Buffer;
  unsigned int           BufferLength; // 0x18 :)
  unsigned int           ProcNum;
  PRPC_SYNTAX_IDENTIFIER TransferSyntax;
  void                   *RpcInterfaceInformation;
  void                   *ReservedForRuntime;
  RPC_MGR_EPV            *ManagerEpv;
  void                   *ImportContext;
  unsigned long          RpcFlags;
} RPC_MESSAGE, *PRPC_MESSAGE;
```

# OSF_CCALL::ProcessResponse

Integer Overflow on OSF_CCALL field `(this+0x150)` and RPC_MESSAGE BufferLength.
```diff
-    uVar3 = *(uint *)(param_2 + 0x18);
-    pvVar4 = *(void **)(param_2 + 0x10);
-    *(uint *)(this + 0x150) = *(int *)(this + 0x150) + uVar3;
-    iVar6 = PutOnQueue((QUEUE *)(this + 0x210),pvVar4,uVar3);
-    if (iVar6 == 0) {
+    uVar6 = *(uint *)(param_2 + 0x18);
+    puVar1 = (uint *)(this + 0x150);
+    pvVar7 = *(void **)(param_2 + 0x10);
+    lVar4 = UIntAdd(*puVar1,uVar6,puVar1);
```

# OSF_SCALL::GetCoalescedBuffer
Integer Overflow on _RPC_MESSAGE field BufferLength.
```diff
 @@ -144232,73 +144593,78 @@ long __thiscall GetCoalescedBuffer(OSF_SCALL *this,_RPC_MESSAGE *param_1,int par
-  iVar8 = *(int *)(this + 0x24c);
-  if (iVar8 != 0) {
-    if (uVar4 != 0) {
-      iVar8 = iVar8 + *(int *)(param_1 + 0x18);
+  uVar9 = *(uint *)(this + 0x24c);
+  if (uVar9 != 0) {
+    if (uVar5 != 0) {
+      this_00 = (MUTEX *)(ulonglong)uVar9;
+      lVar3 = UIntAdd(uVar9,*(uint *)(param_1 + 0x18),local_res18);
+      uVar9 = local_res18[0];
+      if (lVar3 < 0) {
+        lVar3 = 0x6c6;
+        goto LAB_1800ae674;
+      }
```
# OSF_CCALL::GetCoalescedBuffer
Integer Overflow on _RPC_MESSAGE field BufferLength.
See the end of the function, same pattern as `OSF_SCALL::GetCoalescedBuffer`

# OSF_SCALL::ProcessReceivedPDU
IntegerOverflow on OSF_SCALL + 0x24c


# Potentially Unpatched spots

```cpp
long __thiscall SendRequestOrResponse(OSF_SCALL *this,_RPC_MESSAGE *param_1,uchar param_2)

{
  int iVar1;
  uint uVar2;
  int iVar3;
  uint uVar4;
  long lVar5;
  short sVar6;
  undefined2 *puVar7;
  uchar *puVar8;
  ulonglong uVar9;
  longlong lVar10;
  ulonglong uVar11;
  OSF_SCONNECTION *this_00;
  void *pvVar12;
  uint uVar13;
  void *pvVar14;
  uint uVar15;
  
  pvVar14 = (void *)0x0;
  uVar11 = (ulonglong)param_2;
  uVar9 = (ulonglong)*(uint *)(param_1 + 0x18);
  uVar15 = (*(int *)(this + 0x1dc) - *(int *)(this + 0x150)) - 0x18;
  lVar10 = *(longlong *)(param_1 + 0x10);
  pvVar12 = pvVar14;
  uVar2 = GetAdditionalSpaceForSecurity(this);
  puVar7 = (undefined2 *)(lVar10 + -0x18);
  puVar8 = (uchar *)((ulonglong)uVar2 + lVar10 + uVar9);// here? uVar9 is the same bug pattern!
  while( true ) {
    uVar2 = (uint)uVar9;
    if (uVar15 < uVar2) {
      sVar6 = (short)*(undefined4 *)(this + 0x1dc);
    }
    else {
      pvVar14 = (void *)0x1;
      sVar6 = (short)*(undefined4 *)(this + 0x150) + 0x18 + (short)uVar9; // here? uVar9 is the same bug pattern!
    }
```

- `OSF_CCALL::GetBufferWithoutCleanup`
    - BufferLen on `RPC_MESSAGE` unchecked?
- `OSF_SCALL::GetBuffer`
    - BufferLen on `RPC_MESSAGE` unchecked?
- `LSRPC_SCALL::GetBuffer`
    - BufferLen on `RPC_MESSAGE` unchecked?
- `OSF_CCALL::AddVerificationTrailer`
    - BufferLen on RPC+MESSAGE unchecked?
    - memset call?
- `OSF_CCALL::GetCoalescedBuffer`
    - Maybe still vulnerable?
- `OSF_CCALL::ReceiveReply`
    - Underflow on BufferLen  at the end of function?
- `LRPC_BASE_CCALL::AsyncPipeReceive`
    - Overflow on BufferLen

